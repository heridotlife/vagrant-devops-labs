---
#############################################################################
# Deploy Calico CNI
#############################################################################
# This playbook deploys Calico CNI for pod networking
#
# Usage:
#   ansible-playbook -i inventory/hosts.ini playbooks/deploy-calico.yml
#
#############################################################################

- name: Deploy Calico CNI
  hosts: masters[0]
  gather_facts: true
  become: true

  pre_tasks:
    - name: Display deployment information
      debug:
        msg:
          - "╔═══════════════════════════════════════════════════╗"
          - "║        Deploying Calico CNI                       ║"
          - "╚═══════════════════════════════════════════════════╝"
          - "Cluster: {{ cluster_name }}"
          - "Pod CIDR: {{ pod_cidr }}"
          - "Calico Version: {{ calico_version }}"

  roles:
    - role: cni-calico
      tags: ['calico', 'cni', 'network']

  post_tasks:
    - name: Wait for all nodes to be Ready
      command: >
        {{ k8s_bin_dir }}/kubectl wait --for=condition=Ready node --all
        --timeout=300s
        --kubeconfig={{ k8s_config_dir }}/admin.conf
      register: nodes_ready
      until: nodes_ready.rc == 0
      retries: 10
      delay: 30
      changed_when: false
      failed_when: false

    - name: Get node status
      command: >
        {{ k8s_bin_dir }}/kubectl get nodes -o wide
        --kubeconfig={{ k8s_config_dir }}/admin.conf
      register: node_status
      changed_when: false

    - name: Display node status
      debug:
        msg: "{{ node_status.stdout_lines }}"

    - name: Get Calico pod status
      command: >
        {{ k8s_bin_dir }}/kubectl get pods -n kube-system -l k8s-app=calico-node -o wide
        --kubeconfig={{ k8s_config_dir }}/admin.conf
      register: calico_pods
      changed_when: false

    - name: Display Calico pod status
      debug:
        msg: "{{ calico_pods.stdout_lines }}"

    - name: Display completion message
      debug:
        msg:
          - "╔═══════════════════════════════════════════════════╗"
          - "║    Calico CNI Deployment Complete!                ║"
          - "╚═══════════════════════════════════════════════════╝"
          - ""
          - "All nodes should now be in 'Ready' state."
          - "Pod networking is now enabled."
          - ""
          - "You can now deploy applications to the cluster!"
