---
#############################################################################
# Fix Worker Kubeconfigs
#############################################################################
# This playbook regenerates worker kubeconfigs with correct API server address
#############################################################################

- name: Fix Worker Node Kubeconfigs
  hosts: workers
  gather_facts: true
  become: true

  tasks:
    - name: Display current API server address
      debug:
        msg: "Updating kubeconfigs to use API server at: https://{{ apiserver_address }}:6443"

    - name: Backup existing kubelet kubeconfig
      copy:
        src: /var/lib/kubelet/kubeconfig
        dest: /var/lib/kubelet/kubeconfig.backup
        remote_src: yes
      ignore_errors: yes

    - name: Backup existing kube-proxy kubeconfig
      copy:
        src: /var/lib/kube-proxy/kubeconfig
        dest: /var/lib/kube-proxy/kubeconfig.backup
        remote_src: yes
      ignore_errors: yes

    - name: Include kubelet kubeconfig generation
      include_role:
        name: kubelet
        tasks_from: kubeconfig

    - name: Include kube-proxy kubeconfig generation
      include_role:
        name: kube-proxy
        tasks_from: kubeconfig

    - name: Restart kubelet service
      systemd:
        name: kubelet
        state: restarted
        daemon_reload: yes

    - name: Restart kube-proxy service
      systemd:
        name: kube-proxy
        state: restarted
        daemon_reload: yes

    - name: Wait for kubelet to be ready
      wait_for:
        timeout: 30

    - name: Display completion message
      debug:
        msg: "Worker node {{ inventory_hostname }} kubeconfigs updated and services restarted"

- name: Verify Worker Node Registration
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Wait for nodes to register
      pause:
        seconds: 10

    - name: Check node registration
      command: kubectl --kubeconfig=~/.kube/k8s-lab-config get nodes
      register: node_list

    - name: Display registered nodes
      debug:
        msg: "{{ node_list.stdout_lines }}"
