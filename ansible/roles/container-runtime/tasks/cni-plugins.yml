---
#############################################################################
# Container Runtime - CNI Plugins Installation
#############################################################################

- name: Check if CNI plugins are already installed
  stat:
    path: "{{ cni_bin_dir }}/bridge"
  register: cni_installed

- name: Download CNI plugins archive
  get_url:
    url: "{{ cni_plugins_download_url }}"
    dest: "/tmp/cni-plugins-v{{ cni_plugins_version }}.tgz"
    mode: '0644'
    timeout: 300
  when: not cni_installed.stat.exists
  become: true

- name: Extract CNI plugins
  unarchive:
    src: "/tmp/cni-plugins-v{{ cni_plugins_version }}.tgz"
    dest: "{{ cni_bin_dir }}"
    remote_src: yes
    creates: "{{ cni_bin_dir }}/bridge"
  when: not cni_installed.stat.exists
  become: true

- name: Configure SELinux context for CNI bin directory
  community.general.sefcontext:
    target: "{{ cni_bin_dir }}(/.*)?"
    setype: container_file_t
    state: present
  when: ansible_selinux.status == "enabled"
  become: true
  ignore_errors: yes

- name: Configure SELinux context for CNI config directory
  community.general.sefcontext:
    target: "{{ cni_config_dir }}(/.*)?"
    setype: container_file_t
    state: present
  when: ansible_selinux.status == "enabled"
  become: true
  ignore_errors: yes

- name: Apply SELinux context to CNI bin directory
  command: restorecon -R -v {{ cni_bin_dir }}
  when: ansible_selinux.status == "enabled"
  become: true
  changed_when: false
  ignore_errors: yes

- name: Apply SELinux context to CNI config directory
  command: restorecon -R -v {{ cni_config_dir }}
  when: ansible_selinux.status == "enabled"
  become: true
  changed_when: false
  ignore_errors: yes

- name: List installed CNI plugins
  find:
    paths: "{{ cni_bin_dir }}"
    file_type: file
  register: cni_plugins

- name: Display installed CNI plugins
  debug:
    msg: "Installed CNI plugins ({{ cni_plugins.files | length }}): {{ cni_plugins.files | map(attribute='path') | map('basename') | sort | join(', ') }}"
