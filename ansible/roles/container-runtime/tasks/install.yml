---
#############################################################################
# Container Runtime - Containerd Installation
#############################################################################

- name: Download containerd archive
  get_url:
    url: "{{ containerd_download_url }}"
    dest: "/tmp/containerd-{{ containerd_version }}.tar.gz"
    mode: '0644'
    timeout: 300
  when: not containerd_installed.stat.exists
  become: true

- name: Extract containerd binaries
  unarchive:
    src: "/tmp/containerd-{{ containerd_version }}.tar.gz"
    dest: /usr/local
    remote_src: yes
    creates: "{{ containerd_bin_dir }}/containerd"
  when: not containerd_installed.stat.exists
  become: true
  notify: restart containerd

- name: Verify containerd binary installation
  stat:
    path: "{{ containerd_bin_dir }}/containerd"
  register: containerd_binary

- name: Display containerd binary status
  debug:
    msg: "Containerd binary: {{ 'installed' if containerd_binary.stat.exists else 'NOT FOUND' }}"

- name: Get containerd version
  command: "{{ containerd_bin_dir }}/containerd --version"
  register: containerd_version_output
  changed_when: false
  when: containerd_binary.stat.exists

- name: Display containerd version
  debug:
    msg: "{{ containerd_version_output.stdout }}"
  when: containerd_version_output is defined
