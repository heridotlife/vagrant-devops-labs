#############################################################################
# Containerd Configuration for Kubernetes
#############################################################################
# Generated by Ansible - Do not edit manually
#############################################################################

version = 2

# Root directory for containerd metadata
root = "/var/lib/containerd"

# State directory for containerd
state = "/run/containerd"

# Plugin-specific settings
[plugins]
  [plugins."io.containerd.grpc.v1.cri"]
    # Disable SELinux confinement for containers
    enable_selinux = false

    # Sandbox image (pause container)
    sandbox_image = "{{ containerd_sandbox_image }}"

    # Maximum message size for gRPC
    max_container_log_line_size = 16384

    [plugins."io.containerd.grpc.v1.cri".containerd]
      # Snapshotter to use
      snapshotter = "{{ containerd_snapshotter }}"

      # Default runtime
      default_runtime_name = "{{ containerd_runtime }}"

      [plugins."io.containerd.grpc.v1.cri".containerd.runtimes]
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
          runtime_type = "io.containerd.runc.v2"

          [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
            # Use systemd cgroup driver (CRITICAL for Kubernetes)
            SystemdCgroup = {{ containerd_use_systemd_cgroup | lower }}

    [plugins."io.containerd.grpc.v1.cri".cni]
      # CNI plugin binaries directory
      bin_dir = "{{ cni_bin_dir }}"

      # CNI configuration directory
      conf_dir = "{{ cni_config_dir }}"

      # Maximum number of concurrent CNI calls
      max_conf_num = 1

    [plugins."io.containerd.grpc.v1.cri".registry]
{% if containerd_registry_mirrors | length > 0 %}
      [plugins."io.containerd.grpc.v1.cri".registry.mirrors]
{% for registry, mirrors in containerd_registry_mirrors.items() %}
        [plugins."io.containerd.grpc.v1.cri".registry.mirrors."{{ registry }}"]
          endpoint = {{ mirrors | to_json }}
{% endfor %}
{% endif %}

{% if containerd_insecure_registries | length > 0 %}
      [plugins."io.containerd.grpc.v1.cri".registry.configs]
{% for registry in containerd_insecure_registries %}
        [plugins."io.containerd.grpc.v1.cri".registry.configs."{{ registry }}".tls]
          insecure_skip_verify = true
{% endfor %}
{% endif %}

# GRPC configuration
[grpc]
  address = "/run/containerd/containerd.sock"
  max_recv_message_size = {{ containerd_grpc_max_recv_message_size }}
  max_send_message_size = {{ containerd_grpc_max_send_message_size }}

# Metrics configuration
[metrics]
  address = "127.0.0.1:1338"
  grpc_histogram = false

# Stream server configuration
[stream_processors]
  [stream_processors."io.containerd.ocicrypt.decoder.v1.tar.gzip"]
    accepts = ["application/vnd.oci.image.layer.v1.tar+gzip+encrypted"]
    returns = "application/vnd.oci.image.layer.v1.tar+gzip"
