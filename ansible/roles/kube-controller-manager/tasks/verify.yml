---
#############################################################################
# kube-controller-manager - Verification Tasks
#############################################################################

- name: Check if kube-controller-manager is listening
  wait_for:
    host: 127.0.0.1
    port: "{{ controller_manager_secure_port }}"
    timeout: 30

- name: Verify kube-controller-manager process
  command: pgrep -f kube-controller-manager
  register: controller_manager_process
  changed_when: false
  failed_when: controller_manager_process.rc != 0

- name: Check controller-manager health endpoint
  uri:
    url: "https://127.0.0.1:{{ controller_manager_secure_port }}/healthz"
    validate_certs: no
    return_content: yes
  register: healthz_check
  failed_when: healthz_check.status != 200
  retries: 5
  delay: 5

- name: Display verification summary
  debug:
    msg:
      - "════════════════════════════════════════════════════"
      - "  kube-controller-manager Verification Complete"
      - "════════════════════════════════════════════════════"
      - "Status: Running"
      - "Port: {{ controller_manager_secure_port }}"
      - "Health: {{ healthz_check.content }}"
      - "Process ID: {{ controller_manager_process.stdout }}"
