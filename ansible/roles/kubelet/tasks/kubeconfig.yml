---
#############################################################################
# kubelet - Kubeconfig Generation Tasks
#############################################################################

# Note: apiserver_address should be defined in group_vars/all.yml
# - name: Get API server address
#   set_fact:
#     apiserver_address: "{{ hostvars[groups['masters'][0]]['ansible_default_ipv4']['address'] }}"

- name: Generate kubeconfig for kubelet
  block:
    - name: Set cluster in kubeconfig
      command: >
        /usr/local/bin/kubectl config set-cluster {{ cluster_name }}
        --certificate-authority={{ client_ca_file }}
        --embed-certs=true
        --server=https://{{ apiserver_address }}:6443
        --kubeconfig={{ kubeconfig_path }}

    - name: Set credentials in kubeconfig
      command: >
        /usr/local/bin/kubectl config set-credentials system:node:{{ ansible_hostname }}
        --client-certificate={{ tls_cert_file }}
        --client-key={{ tls_private_key_file }}
        --embed-certs=true
        --kubeconfig={{ kubeconfig_path }}

    - name: Set context in kubeconfig
      command: >
        /usr/local/bin/kubectl config set-context default
        --cluster={{ cluster_name }}
        --user=system:node:{{ ansible_hostname }}
        --kubeconfig={{ kubeconfig_path }}

    - name: Use context in kubeconfig
      command: >
        /usr/local/bin/kubectl config use-context default
        --kubeconfig={{ kubeconfig_path }}

- name: Set kubeconfig file permissions
  file:
    path: "{{ kubeconfig_path }}"
    mode: '0600'

- name: Verify kubeconfig exists
  stat:
    path: "{{ kubeconfig_path }}"
  register: kubeconfig_stat
  failed_when: not kubeconfig_stat.stat.exists
