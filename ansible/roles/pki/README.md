# PKI Role

Generates all PKI (Public Key Infrastructure) certificates required for a Kubernetes cluster using OpenSSL.

## Overview

This role implements "Kubernetes The Hard Way" certificate generation approach, creating all certificates manually rather than using automated tools like kubeadm.

## Generated Certificates

### Certificate Authority (CA)
- **ca.crt** - Self-signed root CA certificate
- **ca.key** - CA private key (kept secure, 600 permissions)

### Kubernetes API Server
- **apiserver.crt** - API server certificate with SANs for all access methods
- **apiserver.key** - API server private key
- **apiserver-kubelet-client.crt** - API server client certificate for kubelet communication
- **apiserver-kubelet-client.key** - API server kubelet client private key

### Control Plane Components
- **kube-controller-manager.crt** - Controller manager certificate
- **kube-controller-manager.key** - Controller manager private key
- **kube-scheduler.crt** - Scheduler certificate
- **kube-scheduler.key** - Scheduler private key

### Service Account
- **sa.key** - Service account signing private key
- **sa.pub** - Service account public key

### Admin User
- **admin.crt** - Admin user certificate (system:masters group)
- **admin.key** - Admin user private key

### Node Components
- **{hostname}.crt** - Kubelet certificate (per node)
- **{hostname}.key** - Kubelet private key (per node)
- **kube-proxy.crt** - Kube-proxy certificate
- **kube-proxy.key** - Kube-proxy private key

## Certificate Details

### Validity Period
- **Default**: 3650 days (10 years)
- **Configurable**: Set `cert_validity_days` variable

### Key Size
- **Default**: 2048 bits RSA
- **Configurable**: Set `cert_key_size` variable

### API Server SANs
The API server certificate includes Subject Alternative Names (SANs) for:
- **DNS Names**:
  - kubernetes
  - kubernetes.default
  - kubernetes.default.svc
  - kubernetes.default.svc.cluster.local
  - Master node hostname
  - Master node FQDN
- **IP Addresses**:
  - 127.0.0.1
  - Master node IP
  - Kubernetes service IP (first IP in service CIDR)

## Directory Structure

```
/etc/kubernetes/pki/
├── ca.crt
├── ca.key
├── apiserver.crt
├── apiserver.key
├── apiserver-kubelet-client.crt
├── apiserver-kubelet-client.key
├── kube-controller-manager.crt
├── kube-controller-manager.key
├── kube-scheduler.crt
├── kube-scheduler.key
├── admin.crt
├── admin.key
├── sa.key
├── sa.pub
├── kube-proxy.crt
├── kube-proxy.key
├── {node-name}.crt
└── {node-name}.key
```

## Usage

### Basic Usage

```yaml
- hosts: all
  roles:
    - role: pki
```

### With Custom Variables

```yaml
- hosts: all
  roles:
    - role: pki
      vars:
        cert_validity_days: 1825  # 5 years
        cert_key_size: 4096       # 4096-bit keys
```

### Targeted Certificate Generation

Use tags to generate specific certificates:

```bash
# Generate only CA certificate
ansible-playbook site.yml --tags pki,ca

# Generate only API server certificates
ansible-playbook site.yml --tags pki,apiserver

# Generate all certificates except verification
ansible-playbook site.yml --tags pki --skip-tags verify
```

## Requirements

### Ansible Collections
- `community.crypto` (for OpenSSL modules)

Install with:
```bash
ansible-galaxy collection install community.crypto
```

### System Packages
- OpenSSL (installed automatically by role)

## Variables

### Required Variables
These should be set in inventory or group_vars:

```yaml
service_cidr: "10.96.0.0/16"  # For calculating Kubernetes service IP
```

### Optional Variables

```yaml
# Certificate directories
pki_dir: "/etc/kubernetes/pki"
pki_temp_dir: "/tmp/k8s-pki"

# Certificate validity
cert_validity_days: 3650

# Key configuration
cert_key_size: 2048

# CA configuration
ca_country: "US"
ca_state: "California"
ca_locality: "San Francisco"
ca_organization: "Kubernetes"
ca_organizational_unit: "CA"
ca_common_name: "Kubernetes CA"
```

## Tags

- `pki` - All PKI tasks
- `preflight` - Preflight checks
- `ca` - CA certificate generation
- `apiserver` - API server certificates
- `controller-manager` - Controller manager certificate
- `scheduler` - Scheduler certificate
- `admin` - Admin user certificate
- `service-account` - Service account keys
- `kubelet` - Kubelet certificates
- `proxy` - Kube-proxy certificate
- `distribute` - Certificate distribution
- `verify` - Certificate verification

## Security Considerations

1. **Private Key Protection**
   - All private keys have 600 permissions (owner read/write only)
   - CA private key is only distributed to master nodes

2. **Certificate Lifespan**
   - Default 10-year validity is for lab environments
   - Production environments should use shorter validity periods

3. **Certificate Rotation**
   - Certificates can be regenerated by removing existing ones
   - The role will skip generation if certificates already exist

4. **CA Security**
   - The CA private key is the most sensitive credential
   - Protected with strict file permissions
   - Only stored on master nodes

## Verification

The role includes automatic verification:

1. **Certificate Listing** - Lists all generated certificates
2. **Certificate Details** - Shows subject, validity dates, and issuer
3. **Chain Verification** - Verifies all certificates chain to CA
4. **Summary** - Displays count and list of all certificates

To manually verify:

```bash
# View certificate details
openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout

# Verify certificate chain
openssl verify -CAfile /etc/kubernetes/pki/ca.crt /etc/kubernetes/pki/apiserver.crt

# Check certificate dates
openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -dates
```

## Troubleshooting

### Certificate Already Exists
If certificates exist, the role will skip regeneration. To force regeneration:

```bash
# Remove existing certificates
sudo rm -rf /etc/kubernetes/pki/*.crt /etc/kubernetes/pki/*.key

# Re-run PKI role
ansible-playbook site.yml --tags pki
```

### Permission Denied Errors
Ensure the role is running with become privileges:

```yaml
- hosts: all
  become: true
  roles:
    - pki
```

### Missing Ansible Collection
If you see "module not found" errors:

```bash
ansible-galaxy collection install community.crypto
```

## References

- [Kubernetes The Hard Way - PKI](https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/04-certificate-authority.md)
- [Kubernetes PKI Certificates](https://kubernetes.io/docs/setup/best-practices/certificates/)
- [OpenSSL Certificate Authority](https://jamielinux.com/docs/openssl-certificate-authority/)
